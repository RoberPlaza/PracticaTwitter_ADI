---
- hosts: all
  become: yes
  tasks:
    - name: Update apt
      apt: update_cache=yes

    - name: Install java-jre
      apt: name=default-jre

    - name: Install java-jdk
      apt: name=default-jdk

    - name: Extract hadoop
      unarchive:
        src: http://apache.rediris.es/hadoop/core/hadoop-2.9.1/hadoop-2.9.1.tar.gz
        dest: /home/vagrant/
        remote_src: yes

    - name: Configure hadoop
      copy:
        src: hadoop
        dest: /home/vagrant/hadoop-2.9.1/etc

    - name: Export environment variables
      shell: |
        echo "export HADOOP_HOME=/home/vagrant/hadoop-2.9.1" >> .bashrc
        echo "export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64"  >> .bashrc
        echo "export PATH=$PATH:$HADOOP_HOME/bin:$JAVA_HOME/bin"  >> .bashrc

    - name: Copy hosts
      copy:
        src: hosts.template
        dest: /tmp/hosts
    - name: Add hosts
      shell: cat /tmp/hosts >> /etc/hosts

    - name: Configure SSH
      shell: |
        ssh-keygen -P '' -f /home/vagrant/.ssh/id_rsa
        cat /home/vagrant/.ssh/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys

    - name: Delete default route
      shell: ip route del default
    - name: Add default route
      shell: ip route add default dev eth1